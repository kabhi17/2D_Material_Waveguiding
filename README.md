# 2D_Material_Waveguiding
Code and sample data for analyze waveguiding effects in 2D-nanomaterial assemblies

Please read before using the LabView code that is provided in the GitHub folder. 

Determine whether you want to analyze video files that are captured by the native ThorCam software (Option #1), or analyze a series of images that were collected using LabView (Option #2). I have written a LabView program to capture said images. The LabView program can be found on the desktop of the front laser lab computer. 

Step 1: Open the 'WaveguidingVideoAnalysis.m' file with MATLAB. 

Step 2: If using option #1, run the code in the first section. Make sure you enter the correct start and end timestamp. If you have a 30 second long video, choose a smaller snippet of that video to analyze. A variable 's' will be created which will contain all of the video frames. 

Alternative step 2: Organize your folder that contains your sequence of images (including the 'PreVids'). Enter the name of that folder in the line: G=;. In the myFolder line, enter the directory in which your folder can be found. In line 40, change the extension to '*.jpg'. If you collected tif files, then you leave the extension as '*.TIF'. Run this section of code. At the end, you should get a fully populated and reordered array labelled 's', that contains all your image files. 

Step 3: Analysis. You can either do a batch analysis or a single ROI analysis. For batch analysis, refer to the code in the next section. Run the code in lines 66 to 71 to play your video frames. The video plays with titles and an in-built delay. Use this to identify the frames of interest (i.e.: frames where you see waveguiding effects). 

Step 4: Defining the outline of your laser patterned circle. (Only run this if you have videos where a laser is scanned in a circle). Run lines 74 to 75. Carefully use your mouse to crop out a thin rectangle the length of the circle diameter. Right click the rectangle and select 'crop image'. Run lines 80 to 85 to create a series of points where the laser beam dwells. If you change the LabView inputs to create more laser dwell points, then you need change this section of the code accordingly. 

Step 5: ROI autogeneration. Run lines 86 to 87. Pick out a large region of interest where you see waveguiding effects. Run lines 89 to 96. Choose how small you want the ROIs to be. The larger the number of subdivisions, the smaller the ROIs will be. A very large number of ROIs (<200) will take an excessively long time to analyze in batch (< 1 hour). The 2D array 'RECT' stores information on all of the autogenerated ROIs. 

Step 6: Run lines 99 to 125. Change 'N' to match the number of PreVid frames that you have in the folder. The number of PreVid frames can vary from 10 to 11. Check the folder to make sure. A 2D array labelled 'EN' will be created with data collected from each autogenerated ROI. 

Step 7: Visualizing results. Run lines 128 to 130 to create line plots of frame number vs. RGB emission counts.

Step 8: Calculating theta-phi angles. Run lines 133 to 157. 

Step 9: Fit and plot acceptance angle plots. Choose a value for i between 1 and the maximum number of ROIs in RECT. Run lines 159 to 160. Find the value of i that yields a plot with sufficient strong peaks. Open MATLAB's curve fitting toolbox. Load xaxis and yaxis as variables. Fit the data with a multi-gaussian fit. Extract the fitting parameters (by copying and pasting) and then plot the fitted data. 

## Single frame analysis

The next section (lines 161 to 225) reproduces the image analysis for one single ROI. Lines 163 to 166 can be run to crop out one ROI (for example a bright Au NP that emits light). The variable 'd' is the video frame where this emitter can be identified and cropped out. The ROI that you crop out would be saved as 'ROI1'. Lines 169 to 172 is a repeat of lines 163 to 166, and can be used to crop out a different region from the same video frame. This second ROI is labelled 'ROI2'. You may reproduce these 3 lines of code, while changing the name of the resulting ROI (i.e.: from ROI2 to ROI3) to create more distinct ROIs. Change the frame number where appropriate. 

Lines 175 to 225 should be run to analyze emission from ROI1. You will obtain acceptance angle data from this analysis as well. 

If you have cropped out multiple ROIs. It is advisable that you upend the various ROI coordinates (i.e.: ROI1, ROI2, etc.) into the 2D variable 'RECT'. Once you have created the 2D matrix 'RECT', follow steps 6 to 8 to analyze emission data from your manually cropped out ROIs. 

## Line analysis (For calculating the emission spread) 

This section should be used to process emission that arises along a straight line. I developed this code to calculate the emission spread. 

Step 1: Run lines 231 to 238 to crop out the edges of your straight line. The size of your crop rectangles does not matter, only that your edge lies within this rectangle. In practice, crop out the smallest rectangle possible to identify the edges of your line. 

Step 2: Run lines 241 to 255 to calculate the coordinates of your line edges, autogenerate ROIs between the two line edges, and create a 2D matrix to store the autogenerated ROIs. 

**Note: You can change the density of your autogenerated ROIs by adjusting the value within the parenthesis of line 238 (Default is 30). If you have a short line (e.g.: if the length of your line is < 60 pixels), your autogenerated ROIs will overlap with each other under the default setting. The ROIs are 2 pixels wide, so you need to ensure that the length of your line is at least 2 times larger than the number of autogenerated ROIs. 

Step 3: Run lines 258 to 284 to analyze emission from your autogenerated ROIs. You can choose a smaller set of frames to analyze here. Typically, I analyze a single frame where emission from across your line is visible. In that case, replace 'i=1:420' in line 260 with 'i=X', where X is the frame where you see emission. 

Step 4: Fit your resulting data using MATLAB's curve fitting toolbox. The string EN stores your emission data across the autogenerated ROIs. The xaxis should be the differnece between center of each autogenerated ROI and the center of either edge of your line. See lines 241 to 244 to learn how to calculate the coordinates of the center of an ROI. 

Step 5: Extract your fitting parameters and plot the fitted data. 

## Video writing

This last section shows how to write a video with all of your individual video frames. Run this section to create a video of your individual images that your loaded with section 2. Note that emission brightness is increased by 3 fold while the background brightness is increased by 1.5 fold for increased visibility in the resulting video. You can adjust frame rate if necessary to create a sped up video. 
